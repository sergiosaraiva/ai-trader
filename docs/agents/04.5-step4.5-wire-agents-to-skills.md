What you're doing: Connect agents to the skill router so they automatically load the right patterns for each task

---

Update all 6 Claude Code agents to dynamically invoke skills through the skill router.

**Mode**: Update - Read existing agent files in `.claude/agents/` and update them to use dynamic skill routing instead of static skill tables.

**Prerequisites**:
- Step 3 completed: Agents exist in `.claude/agents/`
- Step 4 completed: `routing-to-skills` skill exists in `.claude/skills/routing-to-skills/SKILL.md`
- Skills exist in `.claude/skills/*/SKILL.md`

**First, consolidate your knowledge on Claude Code agents and skills:**
- https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills
- https://github.com/anthropics/claude-cookbooks/tree/main/skills
- https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview
- https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices

**If unclear about routing integration depth, fallback behavior, or tool permissions, ask for clarification.**

---

## Context: The Gap Being Fixed

The agents were created (Step 3) with **static skill reference tables**:

```markdown
## 5. Skill Integration Points

| Skill | When Applied |
|-------|--------------|
| `backend/creating-fastapi-endpoints` | New routes |
```

The skill router was created (Step 4) but agents **never wired to use it**.

This step updates agents to **dynamically invoke** the skill router and load skills at runtime.

---

## CRITICAL: Preserve YAML Frontmatter

**DO NOT modify the YAML frontmatter** at the top of each agent file. Only update the markdown content after the closing `---`.

The frontmatter (name, description, model, color, allowedTools) must remain unchanged.

---

## Update Each Agent

For each of the 6 agents in `.claude/agents/`:

1. `requirements-analyst.md`
2. `solution-architect.md`
3. `code-engineer.md`
4. `quality-guardian.md`
5. `test-automator.md`
6. `documentation-curator.md`

### Changes Required

#### 1. Update Section 4: Workflow Definition

Add a **Skill Discovery Phase** at the start of implementation phases:

```markdown
### Phase X: Skill Discovery (Before Implementation)

Before starting implementation work:

1. **Analyze task context**:
   - Identify target files and their paths
   - Classify task type (feature, bugfix, refactor, test, etc.)
   - Note any specific technologies or patterns mentioned

2. **Invoke skill router**:
   ```
   Use Skill tool: routing-to-skills

   Provide context:
   - task: [task description]
   - files: [list of target files]
   - context: [additional context]
   - phase: [current workflow phase]
   - agent: [this agent's name]
   ```

3. **Process recommendations**:
   - Review top 3 skill recommendations with confidence scores
   - If confidence >= 0.80: Auto-select top skill
   - If confidence 0.50-0.79: Review recommendations, select most appropriate
   - If confidence < 0.50: Use fallback behavior (see Section 5)

4. **Load selected skill(s)**:
   - Read the skill file using Read tool
   - Extract decision tree and patterns
   - Apply skill guidance to implementation

5. **For multi-skill scenarios** (router returns `multi_skill: true`):
   - Follow the `execution_order` provided by router
   - Apply skills in dependency order (database → schemas → services → routes → frontend)
```

#### 2. Replace Section 5: Skill Integration Points

Replace the static skill table with dynamic routing instructions:

```markdown
## 5. Skill Integration Points

### Dynamic Skill Discovery

This agent uses the `routing-to-skills` meta-skill to dynamically discover and invoke appropriate skills based on task context.

#### Invocation Protocol

1. **When to invoke router**:
   - Starting any implementation task
   - When task spans multiple files/layers
   - When uncertain which pattern to apply
   - After design phase, before coding

2. **Router invocation**:
   ```
   Skill: routing-to-skills

   Input:
   {
     "task": "[description of what needs to be done]",
     "files": ["path/to/file1.py", "path/to/file2.jsx"],
     "context": "[additional context, constraints, requirements]",
     "phase": "implementation|design|testing|documentation",
     "agent": "[this-agent-name]"
   }
   ```

3. **Router output**:
   ```json
   {
     "recommendations": [
       {
         "skill": "creating-python-services",
         "confidence": 0.92,
         "reason": "File path matches service pattern",
         "skill_path": ".claude/skills/backend/creating-python-services.md",
         "next_steps": ["Review pattern", "Apply to implementation"]
       }
     ],
     "multi_skill": false,
     "execution_order": null
   }
   ```

4. **Loading skills**:
   - Use Read tool to load skill content from `skill_path`
   - Follow skill's decision tree
   - Apply patterns from skill's examples
   - Use skill's quality checklist before completing

#### Confidence Thresholds

| Confidence | Action |
|------------|--------|
| >= 0.80 | Auto-select top skill, proceed with implementation |
| 0.50-0.79 | Review top 3 recommendations, select best fit |
| < 0.50 | Fallback triggered (see below) |

#### Fallback Behavior

When router returns low confidence or no match:

1. **Check fallback table** (static backup):
   | Path Pattern | Default Skill |
   |--------------|---------------|
   | `src/api/routes/**` | `backend/creating-api-endpoints.md` |
   | `src/api/services/**` | `backend/creating-python-services.md` |
   | `src/api/schemas/**` | `backend/creating-pydantic-schemas.md` |
   | `src/api/database/**` | `database/SKILL.md` |
   | `frontend/src/components/**` | `frontend/creating-react-components.md` |
   | `frontend/src/api/**` | `frontend/creating-api-clients.md` |
   | `tests/**` | `testing/writing-pytest-tests.md` |
   | `scripts/**` | `build-deployment/SKILL.md` |

2. **If no fallback matches**:
   - Search codebase for similar implementations using Grep
   - Read existing files in same directory for patterns
   - Proceed with manual implementation
   - Document pattern for potential new skill creation

3. **Report missing skill**:
   - Note the gap in implementation summary
   - Consider creating error report in `.claude/improvement/errors/`

#### Multi-Skill Execution

When router returns `multi_skill: true`:

1. Follow `execution_order` array exactly
2. Apply skills in dependency order:
   ```
   database → schemas → services → routes → frontend → tests
   ```
3. Complete each skill's scope before moving to next
4. Verify integration points between layers

#### Skill Override

User can bypass routing with explicit skill selection:
- "Use the creating-python-services skill for this"
- "Skip routing, apply backend patterns directly"

When override detected, load specified skill directly without routing.

### Skills Available for This Agent

The router will select from skills in `.claude/skills/` including:

**Backend**: `creating-api-endpoints`, `creating-python-services`, `creating-pydantic-schemas`, `implementing-prediction-models`, `creating-data-processors`

**Frontend**: `creating-react-components`, `creating-api-clients`

**Database**: `creating-sqlalchemy-models`

**Testing**: `writing-pytest-tests`, `writing-vitest-tests`, `planning-test-scenarios`, `generating-test-data`

**Quality**: `validating-time-series-data`, `creating-dataclasses`

**Build**: `creating-cli-scripts`, `configuring-indicator-yaml`

**Trading Domain**: `running-backtests`, `analyzing-trading-performance`, `implementing-risk-management`

See `.claude/skills/SKILL-INDEX.md` for complete list.
```

#### 3. Update Section 8: Tool Permissions

Add Skill tool to permitted tools:

```markdown
## 8. Tool Permissions

| Tool | Usage |
|------|-------|
| `Skill` | **Invoke routing-to-skills for dynamic skill discovery** |
| `Read` | Read skill files, existing code for patterns |
| `Write` | Create new files |
| `Edit` | Modify existing files |
| `Grep` | Search for patterns, similar implementations |
| `Glob` | Find files by pattern |
| `Bash` | Run verification commands |
| `Task` | Delegate to other agents if needed |

### Skill Tool Usage

```
Skill: routing-to-skills
Args: (optional) JSON context string
```

The Skill tool loads the routing-to-skills meta-skill which analyzes context and returns skill recommendations.
```

#### 4. Update Section 9: Example Conversations

Add an example showing skill routing in action:

```markdown
### Example: Dynamic Skill Routing

```
User: "Add a new endpoint for fetching trade history"

Agent Actions:
1. Analyze task:
   - Task: Add trade history endpoint
   - Files: src/api/routes/trading.py, src/api/schemas/trading.py
   - Type: Feature (add new endpoint)

2. Invoke skill router:
   Skill: routing-to-skills
   Input: {
     "task": "Add endpoint for fetching trade history",
     "files": ["src/api/routes/trading.py", "src/api/schemas/trading.py"],
     "context": "New GET endpoint returning paginated trade history",
     "phase": "implementation",
     "agent": "code-engineer"
   }

3. Router response:
   {
     "recommendations": [
       {"skill": "creating-api-endpoints", "confidence": 0.95},
       {"skill": "creating-pydantic-schemas", "confidence": 0.88}
     ],
     "multi_skill": true,
     "execution_order": ["creating-pydantic-schemas", "creating-api-endpoints"]
   }

4. Load and apply skills in order:
   a. Read .claude/skills/backend/creating-pydantic-schemas.md
      - Follow decision tree for response schema
      - Create TradeHistoryResponse schema

   b. Read .claude/skills/backend/creating-api-endpoints.md
      - Follow decision tree for GET endpoint
      - Add /api/v1/trading/history endpoint
      - Use response_model=TradeHistoryResponse

5. Verify implementation following skill quality checklists

Output: Endpoint implemented following skill patterns
```
```

#### 5. Add to Section 12: Anti-Hallucination Rules

Add routing-specific guardrails:

```markdown
## 12. Anti-Hallucination Rules

[Keep existing rules, add:]

### Skill Routing Guardrails

- **Verify skill exists**: Before loading a skill, use Glob to confirm `.claude/skills/[path]` exists
- **Don't invent skills**: Only use skills that exist in `.claude/skills/` directory
- **Trust router confidence**: If confidence < 0.50, use fallback - don't force a low-confidence match
- **Cite skill source**: When applying a pattern, reference the skill file and section
- **Report gaps**: If no skill matches and fallback fails, document the gap
- **No skill mixing**: Apply one skill's patterns completely before switching to another
```

---

## Agent-Specific Routing Behavior

Each agent has different routing needs:

### requirements-analyst.md
- **Primary use**: Reference skills for capability assessment
- **Router invocation**: Minimal - mainly for understanding what patterns exist
- **Key skills**: Planning-related skills for scoping

### solution-architect.md
- **Primary use**: Reference skills when designing solutions
- **Router invocation**: During design phase to identify applicable patterns
- **Key skills**: All pattern skills for architectural decisions
- **Special**: Invoke `planning-test-scenarios` skill post-design

### code-engineer.md
- **Primary use**: Load implementation patterns before coding
- **Router invocation**: At start of every implementation task
- **Key skills**: All implementation skills (backend, frontend, database)
- **Special**: Follow multi-skill execution order strictly

### quality-guardian.md
- **Primary use**: Reference skills to verify patterns followed correctly
- **Router invocation**: During review to check against expected patterns
- **Key skills**: Quality and testing skills

### test-automator.md
- **Primary use**: Load testing patterns for test generation
- **Router invocation**: Before writing any tests
- **Key skills**: `writing-pytest-tests`, `writing-vitest-tests`, `generating-test-data`

### documentation-curator.md
- **Primary use**: Reference skills for accurate documentation
- **Router invocation**: Minimal - verify documented patterns match skills
- **Key skills**: Reference all skills for accuracy

---

## Update Process

For each agent file:

1. **Read current content**:
   ```
   Read .claude/agents/[agent-name].md
   ```

2. **Preserve YAML frontmatter** (lines 1 through closing `---`)

3. **Update Section 4** (Workflow Definition):
   - Add Skill Discovery phase
   - Integrate routing into existing workflow

4. **Replace Section 5** (Skill Integration Points):
   - Remove static skill table
   - Add dynamic routing instructions
   - Add fallback table
   - Add multi-skill handling

5. **Update Section 8** (Tool Permissions):
   - Add Skill tool for routing

6. **Update Section 9** (Example Conversations):
   - Add routing example

7. **Update Section 12** (Anti-Hallucination Rules):
   - Add skill routing guardrails

8. **Update version footer**:
   ```markdown
   <!-- Agent Metadata
   Version: 1.1.0
   Updated: [TODAY'S DATE]
   Changes: Added dynamic skill routing via routing-to-skills
   Skills Referenced: Dynamic via router
   -->
   ```

---

## Validation Checklist

After updating all agents:

```bash
echo "=== AGENT UPDATE VALIDATION ==="

# 1. Verify YAML frontmatter preserved
for agent in .claude/agents/*.md; do
  filename=$(basename "$agent" .md)
  errors=""

  [ "$(head -1 "$agent")" != "---" ] && errors+="no-frontmatter "
  grep -q "^name: $filename$" "$agent" || errors+="name-mismatch "
  grep -q "^model: \(inherit\|opus\|sonnet\|haiku\)$" "$agent" || errors+="invalid-model "
  grep -q "^color: \(blue\|cyan\|green\|yellow\|magenta\|red\)$" "$agent" || errors+="missing-color "

  if [ -n "$errors" ]; then
    echo "❌ $agent: $errors"
  else
    echo "✅ $agent: Frontmatter OK"
  fi
done

# 2. Verify routing integration added
echo ""
echo "=== ROUTING INTEGRATION CHECK ==="
for agent in .claude/agents/*.md; do
  if grep -q "routing-to-skills" "$agent"; then
    echo "✅ $(basename $agent): Has routing integration"
  else
    echo "❌ $(basename $agent): Missing routing integration"
  fi
done

# 3. Verify Skill tool mentioned
echo ""
echo "=== SKILL TOOL CHECK ==="
for agent in .claude/agents/*.md; do
  if grep -q "Skill tool\|Skill:" "$agent"; then
    echo "✅ $(basename $agent): References Skill tool"
  else
    echo "⚠️  $(basename $agent): No Skill tool reference"
  fi
done

# 4. Verify fallback table exists
echo ""
echo "=== FALLBACK TABLE CHECK ==="
for agent in .claude/agents/*.md; do
  if grep -q "Fallback\|fallback" "$agent"; then
    echo "✅ $(basename $agent): Has fallback behavior"
  else
    echo "⚠️  $(basename $agent): No fallback defined"
  fi
done
```

---

## Output

Updated agent files in `.claude/agents/`:
- `requirements-analyst.md` - v1.1.0 with routing
- `solution-architect.md` - v1.1.0 with routing
- `code-engineer.md` - v1.1.0 with routing
- `quality-guardian.md` - v1.1.0 with routing
- `test-automator.md` - v1.1.0 with routing
- `documentation-curator.md` - v1.1.0 with routing

Each updated with:
- [ ] Skill Discovery phase in workflow
- [ ] Dynamic routing instructions in Section 5
- [ ] Fallback behavior defined
- [ ] Multi-skill execution order
- [ ] Skill tool in permissions
- [ ] Routing example in conversations
- [ ] Routing guardrails in anti-hallucination rules
- [ ] Updated version footer

---

## Summary

This step completes the agent-skill wiring:

```
Before (Step 3):
  Agent → Static skill table (documentation only)

After (Step 4.5):
  Agent → Invoke routing-to-skills → Get recommendations → Load skill → Apply patterns
```

The framework now supports:
1. **Dynamic skill discovery** based on task context
2. **Confidence-based selection** with thresholds
3. **Multi-skill orchestration** in dependency order
4. **Fallback behavior** when routing fails
5. **Manual override** when user specifies skill
6. **Gap reporting** for missing skills

---

## Next Step: Register in CLAUDE.md

**CRITICAL**: After completing agent-skill wiring, you MUST register all agents and skills in the project's CLAUDE.md file.

**Why this is required:**
- CLAUDE.md is the primary configuration file Claude Code reads at session start
- Without registration, Claude won't automatically invoke your agents
- Users would need to manually specify agent names for every task
- The framework's value is significantly reduced without this integration

**Proceed to**: `04.6-step4.6-register-in-claude-md.md`

This step will:
1. Add an "AI Agents & Skills Framework" section to CLAUDE.md
2. Register all agents with their trigger conditions
3. Add mandatory usage instructions so Claude ALWAYS uses agents for matching tasks
4. Include decision trees and examples for reliable agent invocation

**The framework is NOT complete until CLAUDE.md is updated.**
