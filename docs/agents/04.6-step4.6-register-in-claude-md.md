Register all agents and skills in the project's CLAUDE.md file so Claude Code always uses them for related tasks.

**Mode**: Create OR Update - Read existing CLAUDE.md first, then update/enhance the agents and skills sections. Preserve all existing content.

**First, consolidate your knowledge on Claude Code configuration:**
- https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills
- https://github.com/anthropics/claude-cookbooks/tree/main/skills
- https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview
- https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices

**If unclear about section placement, instruction wording, or which agents to prioritize, ask for clarification.**

---

## Why This Step is Critical

CLAUDE.md is the **primary configuration file** that Claude Code reads at the start of every session. Without registering agents and skills here:

- Claude won't know which agents exist
- Claude won't automatically invoke agents for relevant tasks
- Users must manually specify agent names
- The framework's value is significantly reduced

**This step ensures Claude Code ALWAYS uses your agents and skills for their intended purposes.**

---

## Prerequisites

Before running this step, ensure:

1. **Step 2 completed**: Skills exist in `.claude/skills/*/SKILL.md`
2. **Step 3 completed**: Agents exist in `.claude/agents/*.md`
3. **Step 4 completed**: Skill router exists in `.claude/skills/routing-to-skills/SKILL.md`
4. **Step 4.5 completed**: Agents are wired to use skill router

---

## Process

### Phase 1: Inventory Current Framework

Read all agents and skills in parallel:

```
Read .claude/skills/SKILL-INDEX.md || Read .claude/agents/*.md || Read CLAUDE.md
```

**Collect:**
1. All agent names, descriptions, and trigger conditions
2. All skill names and their purposes
3. Current CLAUDE.md structure and content

### Phase 2: Design CLAUDE.md Updates

**Section to add/update: `## Supporting Systems` or `## AI Agents & Skills`**

The section must include:

1. **Agent Registry** - List of all agents with trigger conditions
2. **Skill Categories** - Grouped skills by purpose
3. **Usage Instructions** - Clear directives for when to invoke each agent
4. **Workflow Integration** - How agents fit into development workflow

### Phase 3: Update CLAUDE.md

**CRITICAL: Preserve all existing content. Only ADD or UPDATE the agents/skills section.**

---

## CLAUDE.md Section Template

Add this section to CLAUDE.md (or update if it exists):

```markdown
## AI Agents & Skills Framework

**IMPORTANT**: This project uses a custom Agent-Skill framework. For tasks matching the descriptions below, Claude Code MUST invoke the appropriate agent or skill.

### Agent Registry

The following agents are available and MUST be used for their designated tasks:

| Agent | Purpose | Trigger Conditions |
|-------|---------|-------------------|
| `requirements-analyst` | Analyze work items, identify gaps | "analyze requirements", "review work item", "identify specification gaps" |
| `solution-architect` | Design solutions, create plans | "design solution", "create implementation plan", "plan the architecture" |
| `code-engineer` | Implement code changes | "implement feature", "write code", "make changes to" |
| `quality-guardian` | Code review, regression analysis | "review code", "check quality", "analyze for regressions" |
| `test-automator` | Generate and run tests | "write tests", "create test cases", "run tests" |
| `documentation-curator` | Generate documentation | "document", "create README", "write API docs" |

### Mandatory Agent Usage

**YOU MUST invoke the appropriate agent when:**

1. **Work Item Analysis**: When user mentions work item IDs or asks to analyze requirements
   ```
   User: "Analyze work item #12345"
   Action: Use Task tool with requirements-analyst agent
   ```

2. **Solution Design**: When user asks to design or plan implementation
   ```
   User: "Plan how to implement the export feature"
   Action: Use Task tool with solution-architect agent
   ```

3. **Code Implementation**: When user asks to implement, code, or make changes
   ```
   User: "Implement the user authentication"
   Action: Use Task tool with code-engineer agent
   ```

4. **Quality Assurance**: When user asks to review, check quality, or analyze
   ```
   User: "Review my changes for issues"
   Action: Use Task tool with quality-guardian agent
   ```

5. **Testing**: When user asks to write, create, or run tests
   ```
   User: "Write unit tests for UserService"
   Action: Use Task tool with test-automator agent
   ```

6. **Documentation**: When user asks to document or create documentation
   ```
   User: "Document the API endpoints"
   Action: Use Task tool with documentation-curator agent
   ```

### Skill Categories

Skills are automatically invoked by agents through the `routing-to-skills` meta-skill. Available categories:

- **Backend**: Service creation, API patterns, business logic
- **Frontend**: UI components, state management, styling
- **Database**: Schema design, queries, migrations
- **Testing**: Unit tests, integration tests, test data
- **Quality**: Code review, security scanning, performance
- **Build**: Build scripts, deployment, CI/CD

### Development Workflow

For complex tasks, agents work in sequence:

```
requirements-analyst → solution-architect → code-engineer → quality-guardian → test-automator → documentation-curator
```

**Full workflow command**: `/work-item [id]` orchestrates all phases automatically.

### Agent Invocation Examples

<example>
Context: Developer wants to analyze a new feature request
user: "I have a new work item #12345, can you analyze it?"
assistant: "I'll use the requirements-analyst agent to analyze this work item."
[Uses Task tool with requirements-analyst]
</example>

<example>
Context: Developer needs to implement a bug fix
user: "Fix the null reference error in CustomerService"
assistant: "I'll use the code-engineer agent to investigate and fix this issue."
[Uses Task tool with code-engineer]
</example>

<example>
Context: Developer wants comprehensive code review
user: "Review my changes before I create a PR"
assistant: "I'll use the quality-guardian agent to perform a comprehensive review."
[Uses Task tool with quality-guardian]
</example>
```

---

## Implementation Steps

### Step 1: Read Current CLAUDE.md

```
Read CLAUDE.md
```

Identify:
- Existing structure and sections
- Where to add/update the agents section
- Any existing agent/skill references to update

### Step 2: Inventory Agents

For each agent in `.claude/agents/*.md`:

1. Extract `name` from YAML frontmatter
2. Extract `description` for purpose
3. Extract `<example>` blocks for trigger conditions
4. Note which skills it references

Generate agent registry table:

```markdown
| Agent | Purpose | Triggers |
|-------|---------|----------|
| [name] | [from description] | [from examples] |
```

### Step 3: Inventory Skills

Read `.claude/skills/SKILL-INDEX.md` and categorize:

```markdown
### Skill Categories
- **[Category]**: [list of skill names]
```

### Step 4: Update CLAUDE.md

**Insert or update the `## AI Agents & Skills Framework` section.**

Location options (in order of preference):
1. After `## Supporting Systems` if it exists
2. After `## Development Workflow` if it exists
3. Before `## Environment Access & Testing` if it exists
4. At the end of the file

**Use Edit tool to insert the section, preserving all existing content.**

### Step 5: Verify Integration

After updating, verify:

1. CLAUDE.md still valid markdown
2. All agent names correctly listed
3. All trigger conditions accurate
4. No broken internal links

---

## Validation Checklist

After updating CLAUDE.md, run these checks:

```bash
echo "=== CLAUDE.MD VALIDATION ==="

# Check file exists and is readable
[ -f "CLAUDE.md" ] && echo "✅ CLAUDE.md exists" || echo "❌ CLAUDE.md missing"

# Check agents section exists
grep -q "## AI Agents" CLAUDE.md && echo "✅ Agents section exists" || echo "❌ Agents section missing"

# Check all agents are mentioned
for agent in .claude/agents/*.md; do
  name=$(basename "$agent" .md)
  grep -q "$name" CLAUDE.md && echo "✅ Agent $name registered" || echo "❌ Agent $name NOT registered"
done

# Check mandatory usage section exists
grep -q "MUST invoke" CLAUDE.md && echo "✅ Mandatory usage section exists" || echo "⚠️ No mandatory usage instructions"

# Check examples exist
grep -q "<example>" CLAUDE.md && echo "✅ Examples provided" || echo "⚠️ No examples in agents section"
```

---

## Output

Updated `CLAUDE.md` with:

1. **Agent Registry Table** - All agents with purposes and triggers
2. **Mandatory Usage Section** - Clear instructions on when to invoke each agent
3. **Skill Categories** - Grouped skills for reference
4. **Workflow Integration** - How agents fit into development
5. **Examples** - Concrete examples of agent invocation

---

## Maintenance

**When to re-run this step:**

1. After creating new agents (Step 3)
2. After creating new skills (Step 2)
3. After updating agent descriptions or triggers
4. After archiving or merging agents/skills
5. During quarterly maintenance (Step 8)

**Update process:**

1. Read current CLAUDE.md
2. Compare against current `.claude/agents/` and `.claude/skills/`
3. Update agent registry table
4. Update skill categories
5. Update trigger conditions if changed
6. Verify all examples still accurate

---

## Example CLAUDE.md Update

**Before** (excerpt):
```markdown
## Development Workflow

**Automated**: Use TodoWrite for tracking...
```

**After** (excerpt):
```markdown
## Development Workflow

**Automated**: Use TodoWrite for tracking...

## AI Agents & Skills Framework

**IMPORTANT**: This project uses a custom Agent-Skill framework...

[Full section as per template above]
```

---

## Critical Instructions for Claude Code

The updated CLAUDE.md MUST include these explicit directives:

```markdown
### CRITICAL: Agent Usage Requirements

1. **DO NOT** attempt tasks manually if a specialized agent exists
2. **ALWAYS** check this section before starting work
3. **INVOKE** the appropriate agent using the Task tool
4. **FOLLOW** agent recommendations and skill guidance
5. **REPORT** when no agent matches the task (for framework improvement)

### Agent Selection Decision Tree

```
Is this a work item analysis task?
├─ Yes → Use requirements-analyst
└─ No
   ├─ Is this a design/planning task?
   │   ├─ Yes → Use solution-architect
   │   └─ No
   │       ├─ Is this a code implementation task?
   │       │   ├─ Yes → Use code-engineer
   │       │   └─ No
   │       │       ├─ Is this a review/quality task?
   │       │       │   ├─ Yes → Use quality-guardian
   │       │       │   └─ No
   │       │       │       ├─ Is this a testing task?
   │       │       │       │   ├─ Yes → Use test-automator
   │       │       │       │   └─ No
   │       │       │       │       ├─ Is this a documentation task?
   │       │       │       │       │   ├─ Yes → Use documentation-curator
   │       │       │       │       │   └─ No → Proceed manually, report gap
```
```

---

## Version Footer

```markdown
<!-- Step 4.6 Metadata
Version: 1.0.0
Created: YYYY-MM-DD
Purpose: Register agents and skills in CLAUDE.md for automatic invocation
Dependencies: Steps 2, 3, 4, 4.5 completed
-->
```
